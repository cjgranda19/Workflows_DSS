name: Security Scan on Pull Requests

on:
  pull_request:
    branches: [ "dev", "test", "main" ]
    paths:
      - "**/*.py"
      - "**/*.java"
      - "**/*.js"
      - "**/*.c"
      - "**/*.cs"

  workflow_dispatch:

jobs:
  security-scan:
    name: Analyze Code Vulnerabilities
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        pip install -r requirements.txt || true
        pip install joblib datasets scikit-learn==1.5.2 scipy requests pandas

    - name: List changed files
      id: files
      uses: tj-actions/changed-files@v39

    - name: Select code file to analyze
      id: pickfile
      run: |
        echo "Detecting modified source files..."
        for file in ${{ steps.files.outputs.all_changed_files }}; do
          if [[ $file == *.py || $file == *.java || $file == *.js || $file == *.c || $file == *.cs ]]; then
            echo "file_to_scan=$file" >> $GITHUB_OUTPUT
            exit 0
          fi
        done
        echo "file_to_scan=NONE" >> $GITHUB_OUTPUT

    - name: Stop if no analyzable file
      if: steps.pickfile.outputs.file_to_scan == 'NONE'
      run: |
        echo "No .py/.java/.js/.c/.cs file detected"
        exit 0

    - name: Run Security Check
      id: scan
      run: |
        RESULT=$(python scripts/security_check.py "${{ steps.pickfile.outputs.file_to_scan }}")
        echo "result=$RESULT" >> $GITHUB_OUTPUT
        echo "Security check result:"
        echo "$RESULT"

    - name: Notify Telegram
      if: always() && steps.pickfile.outputs.file_to_scan != 'NONE'
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        python scripts/telegram_notify.py "${{ steps.pickfile.outputs.file_to_scan }}" '${{ steps.scan.outputs.result }}'

    - name: Parse result
      id: parse
      run: |
        echo '${{ steps.scan.outputs.result }}' > result.json
        STATUS=$(jq -r '.status' result.json)
        PROB=$(jq -r '.probability_vulnerable' result.json)
        echo "status=$STATUS" >> $GITHUB_OUTPUT
        echo "prob=$PROB" >> $GITHUB_OUTPUT

    - name: Create issue if vulnerable
      if: steps.parse.outputs.status == 'VULNERABLE'
      uses: peter-evans/create-issue-from-file@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        title: "ğŸš¨ Vulnerabilidad detectada en PR #${{ github.event.pull_request.number }}"
        body: |
          Se detectÃ³ una vulnerabilidad:
          - Archivo: **${{ steps.pickfile.outputs.file_to_scan }}**
          - Estado: **${{ steps.parse.outputs.status }}**
          - Probabilidad: **${{ steps.parse.outputs.prob }}**

          El merge fue bloqueado automÃ¡ticamente.

    - name: Block merge if vulnerable
      if: steps.parse.outputs.status == 'VULNERABLE'
      run: |
        echo "âŒ Vulnerabilidad detectada. Bloqueando merge."
        exit 1

    - name: Approve if safe
      if: steps.parse.outputs.status == 'SAFE'
      run: |
        echo "âœ… CÃ³digo seguro. Merge permitido."
