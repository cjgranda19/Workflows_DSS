name: Auto-Merge Dev to Main

on:
  push:
    branches:
      - dev

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  security-check-all:
    name: Full Security Scan Before Merge
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        pip install -r requirements.txt || true
        pip install joblib datasets scikit-learn==1.5.2 scipy requests pandas

    - name: Scan all files
      id: scan
      run: |
        echo "🔍 Iniciando escaneo de seguridad..."
        FAILED=0
        JS_COUNT=0
        JAVA_COUNT=0
        PY_COUNT=0
        VULNERABLE_FILES=""
        
        # JavaScript
        for file in $(find . -name "*.js" -not -path "*/node_modules/*" -not -path "*/.venv/*" -not -path "*/.next/*"); do
          JS_COUNT=$((JS_COUNT + 1))
          RESULT=$(python scripts/security_check.py "$file")
          STATUS=$(echo "$RESULT" | jq -r '.status')
          if [ "$STATUS" = "VULNERABLE" ]; then
            echo "❌ VULNERABLE: $file"
            PROB=$(echo "$RESULT" | jq -r '.probability')
            LANG=$(echo "$RESULT" | jq -r '.language')
            FUNCS=$(echo "$RESULT" | jq -r '.dangerous_functions')
            OWASP=$(echo "$RESULT" | jq -r '.owasp_category')
            VULNERABLE_FILES="${VULNERABLE_FILES}FILE:${file}|PROB:${PROB}|LANG:${LANG}|FUNCS:${FUNCS}|OWASP:${OWASP};"
            FAILED=1
          fi
        done
        
        # Java
        for file in $(find . -name "*.java" -not -path "*/node_modules/*" -not -path "*/.venv/*"); do
          JAVA_COUNT=$((JAVA_COUNT + 1))
          RESULT=$(python scripts/security_check.py "$file")
          STATUS=$(echo "$RESULT" | jq -r '.status')
          if [ "$STATUS" = "VULNERABLE" ]; then
            echo "❌ VULNERABLE: $file"
            PROB=$(echo "$RESULT" | jq -r '.probability')
            LANG=$(echo "$RESULT" | jq -r '.language')
            FUNCS=$(echo "$RESULT" | jq -r '.dangerous_functions')
            OWASP=$(echo "$RESULT" | jq -r '.owasp_category')
            VULNERABLE_FILES="${VULNERABLE_FILES}FILE:${file}|PROB:${PROB}|LANG:${LANG}|FUNCS:${FUNCS}|OWASP:${OWASP};"
            FAILED=1
          fi
        done
        
        # Python
        for file in $(find . -name "*.py" -not -path "*/node_modules/*" -not -path "*/.venv/*" -not -path "*/scripts/*"); do
          PY_COUNT=$((PY_COUNT + 1))
          RESULT=$(python scripts/security_check.py "$file")
          STATUS=$(echo "$RESULT" | jq -r '.status')
          if [ "$STATUS" = "VULNERABLE" ]; then
            echo "❌ VULNERABLE: $file"
            PROB=$(echo "$RESULT" | jq -r '.probability')
            LANG=$(echo "$RESULT" | jq -r '.language')
            FUNCS=$(echo "$RESULT" | jq -r '.dangerous_functions')
            OWASP=$(echo "$RESULT" | jq -r '.owasp_category')
            VULNERABLE_FILES="${VULNERABLE_FILES}FILE:${file}|PROB:${PROB}|LANG:${LANG}|FUNCS:${FUNCS}|OWASP:${OWASP};"
            FAILED=1
          fi
        done
        
        echo "js_count=$JS_COUNT" >> $GITHUB_OUTPUT
        echo "java_count=$JAVA_COUNT" >> $GITHUB_OUTPUT
        echo "py_count=$PY_COUNT" >> $GITHUB_OUTPUT
        echo "vulnerable_details=$VULNERABLE_FILES" >> $GITHUB_OUTPUT
        
        if [ $FAILED -eq 1 ]; then
          echo "❌ Vulnerabilidades detectadas!"
          exit 1
        fi
        
        echo "✅ Todos los archivos son seguros"

    - name: Send Telegram on failure
      if: failure()
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        DETAILS="${{ steps.scan.outputs.vulnerable_details }}"
        
        # Construir mensaje detallado
        MESSAGE="🚨 *Auto-Merge BLOQUEADO*%0A%0A❌ *Estado:* VULNERABLE%0A📂 *Rama:* dev → main%0A🚫 *Acción:* Merge bloqueado%0A%0A*🔍 Archivos Vulnerables:*%0A"
        
        # Parsear detalles de archivos vulnerables
        IFS=';' read -ra FILES <<< "$DETAILS"
        for item in "${FILES[@]}"; do
          if [ ! -z "$item" ]; then
            FILE=$(echo "$item" | grep -oP 'FILE:\K[^|]+')
            PROB=$(echo "$item" | grep -oP 'PROB:\K[^|]+')
            LANG=$(echo "$item" | grep -oP 'LANG:\K[^|]+')
            FUNCS=$(echo "$item" | grep -oP 'FUNCS:\K[^|]+')
            OWASP=$(echo "$item" | grep -oP 'OWASP:\K[^|]+')
            
            # Calcular porcentaje
            PERCENT=$(echo "$PROB * 100" | bc)
            PERCENT_INT=$(printf "%.0f" $PERCENT)
            
            MESSAGE="${MESSAGE}%0A📄 \`${FILE}\`%0A🔤 *Lenguaje:* ${LANG}%0A⚠️ *Probabilidad:* ${PERCENT_INT}%%%0A🛡️ *OWASP:* ${OWASP}%0A🔧 *Funciones:* ${FUNCS}%0A"
          fi
        done
        
        MESSAGE="${MESSAGE}%0A⚠️ *Revisa GitHub Actions para más detalles*"
        
        curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
          -d "chat_id=${TELEGRAM_CHAT_ID}" \
          -d "text=${MESSAGE}" \
          -d "parse_mode=Markdown"

    - name: Create Issue on failure
      if: failure()
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const details = '${{ steps.scan.outputs.vulnerable_details }}';
          const files = details.split(';').filter(f => f.length > 0);
          
          let issueBody = '## 🚨 Vulnerabilidades Detectadas en Dev\n\n';
          issueBody += '**Auto-merge bloqueado** debido a código vulnerable detectado.\n\n';
          issueBody += '### 📊 Archivos Vulnerables:\n\n';
          
          files.forEach(item => {
            const file = item.match(/FILE:([^|]+)/)?.[1];
            const prob = item.match(/PROB:([^|]+)/)?.[1];
            const lang = item.match(/LANG:([^|]+)/)?.[1];
            const funcs = item.match(/FUNCS:([^|]+)/)?.[1];
            const owasp = item.match(/OWASP:([^|]+)/)?.[1];
            
            if (file) {
              const percent = (parseFloat(prob) * 100).toFixed(0);
              issueBody += `#### 📄 \`${file}\`\n`;
              issueBody += `- **Lenguaje:** ${lang}\n`;
              issueBody += `- **Probabilidad de Vulnerabilidad:** ${percent}%\n`;
              issueBody += `- **Categoría OWASP:** ${owasp}\n`;
              issueBody += `- **Funciones Peligrosas:** ${funcs}\n\n`;
            }
          });
          
          issueBody += '### 🔧 Acción Requerida:\n';
          issueBody += '1. Revisar los archivos mencionados\n';
          issueBody += '2. Corregir las vulnerabilidades detectadas\n';
          issueBody += '3. Hacer commit de los cambios\n';
          issueBody += '4. El auto-merge se ejecutará automáticamente si el código es seguro\n\n';
          issueBody += `**Commit:** ${{ github.sha }}\n`;
          issueBody += `**Rama:** dev\n`;
          
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: '🚨 Auto-Merge Bloqueado: Vulnerabilidades Detectadas',
            body: issueBody,
            labels: ['security', 'vulnerability', 'auto-merge-blocked']
          });

    - name: Send Telegram on success
      if: success()
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        MESSAGE=" *Escaneo Completo*%0A%0A *Estado:* SAFE%0A *Rama:* dev%0A *Archivos:* JS=${{ steps.scan.outputs.js_count }} Java=${{ steps.scan.outputs.java_count }} Py=${{ steps.scan.outputs.py_count }}%0A%0A Mergeando a main"
        curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" -d "chat_id=${TELEGRAM_CHAT_ID}" -d "text=${MESSAGE}" -d "parse_mode=Markdown"

  merge-to-main:
    name: Merge Dev to Main
    needs: security-check-all
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/dev'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
        persist-credentials: true

    - name: Configure Git
      run: |
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "actions@github.com"

    - name: Merge dev into main
      run: |
        git fetch origin main
        git checkout main
        git merge --no-ff origin/dev -m " Auto-merge dev to main after security checks passed"
        git push origin main

    - name: Success notification
      run: |
        echo " Successfully merged dev to main!"
